<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gieo Qu·∫ª - Th·∫ßy B√≥i S·ªë</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Philosopher:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { width: 100%; height: 100%; overflow: hidden; }
  :root {
    --dark-red: #5c0000;
    --gold: #D4AF37;
    --gold-light: #FFD700;
    --gold-dark: #9e7e1a;
  }
  body {
    background: #1a0000;
    font-family: 'Philosopher', serif;
    overflow: hidden;
    width: 100vw;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
  }
  .scene {
    position: relative;
    width: 100vw;
    height: 100vh;
    background: radial-gradient(ellipse at 50% 25%, #b00000 0%, #6b0000 45%, #3d0000 75%, #1a0000 100%);
    overflow: hidden;
  }
  .wall-pattern {
    position: absolute; inset: 0;
    background-image:
      repeating-linear-gradient(0deg, transparent, transparent 39px, rgba(0,0,0,0.12) 40px),
      repeating-linear-gradient(90deg, transparent, transparent 39px, rgba(0,0,0,0.12) 40px);
    pointer-events: none; z-index: 0;
  }
  .top-border {
    position: absolute; top: 0; left: 0; right: 0; height: 28px;
    background: linear-gradient(to right, transparent, var(--gold-dark), var(--gold), var(--gold-dark), transparent);
    z-index: 5; display: flex; align-items: center; justify-content: center;
    font-family: 'Cinzel Decorative', serif; color: var(--dark-red); font-size: 9px; letter-spacing: 8px;
  }
  /* LANTERNS */
  .lantern { position: absolute; top: 40px; width: 30px; z-index: 6; animation: lanternSway 3s ease-in-out infinite alternate; transform-origin: top center; }
  .lantern-left { left: 110px; }
  .lantern-right { right: 110px; animation-delay: -1.5s; }
  .lantern-cord { width: 2px; height: 28px; background: var(--gold-dark); margin: 0 auto; }
  .lantern-top, .lantern-bottom { height: 7px; background: var(--gold-dark); border-radius: 2px; }
  .lantern-body {
    width: 30px; height: 48px;
    background: linear-gradient(135deg, var(--gold-light), #ff8c00, var(--gold));
    border-radius: 5px 5px 8px 8px;
    box-shadow: 0 0 25px rgba(255,150,0,0.9), 0 0 50px rgba(255,100,0,0.4);
    position: relative;
  }
  .lantern-body::after { content:''; position:absolute; top:5px;left:5px;right:5px;bottom:5px; border:1px solid rgba(255,255,255,0.25); border-radius:3px; }
  .lantern-glow { position:absolute; bottom:-40px; left:50%; transform:translateX(-50%); width:80px; height:100px; background:radial-gradient(ellipse, rgba(255,140,0,0.25), transparent 70%); pointer-events:none; }
  @keyframes lanternSway { from{transform:rotate(-4deg);}to{transform:rotate(4deg);} }

  /* INCENSE */
  .incense-container { position: absolute; bottom: 218px; z-index: 6; }
  .incense-left { left: 130px; }
  .incense-right { right: 130px; }
  .incense-stick { width: 5px; height: 70px; background: linear-gradient(to top, var(--gold-dark), #c8a84b); margin: 0 auto; border-radius: 2px; }
  .smoke { position: absolute; bottom: 70px; left: 2px; width: 16px; }
  .smoke-puff { width:10px;height:10px;background:rgba(255,255,255,0.12);border-radius:50%;position:absolute;animation:smokeRise 3.5s ease-out infinite; }
  .smoke-puff:nth-child(2){animation-delay:1.2s;}.smoke-puff:nth-child(3){animation-delay:2.4s;}
  @keyframes smokeRise { 0%{bottom:0;opacity:0.5;transform:translateX(0)scale(0.4);}100%{bottom:110px;opacity:0;transform:translateX(-18px)scale(2.2);} }

  /* TABLE */
  .table { position:absolute; bottom:0;left:0;right:0; height:220px; background:linear-gradient(to bottom,#5c2e12,#3d1e0a,#2a1508); z-index:8; box-shadow:0 -8px 30px rgba(0,0,0,0.6); }
  .table-surface { height:22px; background:linear-gradient(to bottom,#a0622e 0%,#8c5226 40%,#7a4620 100%); box-shadow:0 3px 12px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,200,120,0.3); }
  .table-grain { position:absolute;inset:22px 0 0 0; background-image:repeating-linear-gradient(90deg,transparent 0px,transparent 5px,rgba(0,0,0,0.04) 5px,rgba(0,0,0,0.04) 6px); }
  .table-leg { position:absolute;bottom:0;width:18px;height:140px; background:linear-gradient(to right,#3d1e0a,#5c2e12,#3d1e0a); border-radius:2px; }
  .table-leg-left{left:80px;}.table-leg-right{right:80px;}

  /* CHARACTER */
  .fortune-teller { position:absolute; bottom:220px; left:50%; transform:translateX(-50%); z-index:9; animation:fortuneFloat 4s ease-in-out infinite; }
  .character-svg { width:230px; filter:drop-shadow(0 12px 30px rgba(0,0,0,0.9)); display:block; }
  @keyframes fortuneFloat {
    0%,100% { transform:translateX(-50%) translateY(0px); }
    50% { transform:translateX(-50%) translateY(-10px); }
  }

  /* CUP */
  .cup-area {
    position: absolute;
    bottom: 225px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 12;
    cursor: pointer;
    width: 65px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .sticks-group { position:relative; width:58px; height:38px; margin-bottom:-4px; }
  .stick { position:absolute; bottom:0; width:3px; border-radius:1px; background:linear-gradient(to top,#8B6914 0%,#c8a84b 40%,#deba68 60%,#c8a84b 100%); transform-origin:bottom center; }
  .cup-svg { width:60px; filter:drop-shadow(0 4px 10px rgba(0,0,0,0.6)); transition:filter 0.2s; }
  .cup-area:hover .cup-svg { filter:drop-shadow(0 4px 18px rgba(212,175,55,0.55)); }
  .cup-label { position:absolute; bottom:16px; left:50%; transform:translateX(-50%); font-family:'Philosopher',serif; font-weight:700; font-size:9px; color:var(--dark-red); text-align:center; line-height:1.2; pointer-events:none; white-space:nowrap; }

  .cup-area.shaking { animation:cupShake 0.7s ease-in-out; }
  @keyframes cupShake {
    0%,100%{transform:translateX(-50%) rotate(0deg);}
    10%{transform:translateX(calc(-50% - 6px)) rotate(-10deg);}
    20%{transform:translateX(calc(-50% + 6px)) rotate(10deg);}
    30%{transform:translateX(calc(-50% - 5px)) rotate(-8deg);}
    40%{transform:translateX(calc(-50% + 5px)) rotate(8deg);}
    50%{transform:translateX(calc(-50% - 3px)) rotate(-5deg);}
    60%{transform:translateX(calc(-50% + 3px)) rotate(5deg);}
    70%{transform:translateX(calc(-50% - 2px)) rotate(-3deg);}
    80%{transform:translateX(calc(-50% + 2px)) rotate(3deg);}
    90%{transform:translateX(-50%) rotate(0deg);}
  }

  /* RESULT SCROLL */
  /* RESULT SCROLL - VERTICAL LAYOUT */
  .result-scroll {
    position: absolute;
    bottom: 190px;
    left: 50%;
    transform: translateX(-50%) translateY(60px) scale(0.6) rotate(8deg);
    z-index: 18;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease-out, transform 0.6s cubic-bezier(0.22,1.2,0.36,1);
    width: 520px;
    text-align: center;
    transform-origin: center bottom;
  }
  .result-scroll.visible { opacity:1; pointer-events:all; transform:translateX(-50%) translateY(0) scale(1) rotate(0deg); }

  /* Cu·ªôn ngang hai ƒë·∫ßu tr√™n/d∆∞·ªõi */
  .scroll-wrapper {
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
  .scroll-roll-left, .scroll-roll-right {
    height: 16px; flex-shrink: 0;
    background: linear-gradient(to right, var(--gold-dark), var(--gold-light), var(--gold-dark));
    border-radius: 50%;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    position: relative; z-index: 2;
  }
  .scroll-content {
    background: linear-gradient(170deg,#fef9e5 0%,#f5e6a3 50%,#fef0c0 100%);
    border-left: 2px solid var(--gold-dark);
    border-right: 2px solid var(--gold-dark);
    padding: 18px 26px 14px;
    box-shadow: 0 0 30px rgba(212,175,55,0.8), 0 8px 25px rgba(0,0,0,0.6);
    position: relative;
  }
  .scroll-content::before {
    content:''; position:absolute; inset:0;
    background: repeating-linear-gradient(0deg, transparent 0, transparent 22px, rgba(180,140,80,0.07) 23px);
    pointer-events:none;
  }
  /* N·ªôi dung b√™n trong cu·ªôn d·ªçc */
  .scroll-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    text-align: center;
  }
  .scroll-left-col {
    width: 100%; text-align: center;
    border-bottom: 1px solid rgba(158,126,26,0.35);
    padding-bottom: 10px;
  }
  .scroll-right-col {
    width: 100%; text-align: center;
  }
  .scroll-label {
    font-family:'Cinzel Decorative',serif; font-size:7px; letter-spacing:3px;
    color:var(--gold-dark); margin-bottom:5px; text-transform:uppercase;
  }
  .scroll-name {
    font-family: 'Philosopher', serif; font-size: 30px; font-weight: 700;
    color: var(--dark-red);
    text-shadow: 2px 2px 0 rgba(212,175,55,0.6), 0 0 12px rgba(180,0,0,0.25);
    line-height: 1.2; margin-bottom: 0; font-style: normal;
    letter-spacing: 1px;
  }
  .scroll-que-result {
    font-family: 'Philosopher', serif; font-size: 11px; font-style: italic;
    color: var(--gold-dark); margin-top: 5px; letter-spacing: 1px;
  }
  .scroll-que-name {
    font-family: 'Arial Black', Arial, sans-serif; font-size: 26px; font-weight: 900;
    font-style: normal; letter-spacing: 1.5px;
    color: var(--dark-red); text-shadow: 2px 2px 0 rgba(212,175,55,0.5);
    line-height: 1.2; margin-bottom: 6px;
  }
  .scroll-sub {
    font-family: 'Philosopher', serif;
    font-size: 14px; color: #3a1a08;
    line-height: 1.7; letter-spacing: 0.2px;
    font-style: italic;
  }
  .scroll-divider { display:none; }

  /* N√∫t b·∫•m */
  .scroll-btn-row {
    display:flex; gap:8px; justify-content:center; margin-top:10px;
    position:relative; z-index:22;
  }
  .scroll-close {
    display:inline-block;
    background:linear-gradient(to right,var(--gold-dark),var(--gold),var(--gold-dark));
    color:var(--dark-red); border:none; padding:8px 18px;
    font-family:'Philosopher',serif; font-weight:700; font-size:12px;
    letter-spacing:2px; cursor:pointer; border-radius:3px;
    box-shadow:0 2px 8px rgba(0,0,0,0.3); transition:transform 0.15s;
  }
  .scroll-close:hover{transform:scale(1.05);}
  .scroll-quiz-btn {
    display:inline-block;
    background:linear-gradient(to right,#2a0a0a,#8b1a1a,#2a0a0a);
    color:var(--gold-light); border:1px solid var(--gold-dark);
    padding:8px 18px; font-family:'Philosopher',serif; font-weight:700;
    font-size:12px; letter-spacing:1px; cursor:pointer; border-radius:3px;
    box-shadow:0 2px 8px rgba(0,0,0,0.3); transition:transform 0.15s;
  }
  .scroll-quiz-btn:hover{transform:scale(1.05);}

  /* PERMISSION OVERLAY */
  #camPermOverlay {
    position: absolute; inset: 0; z-index: 80;
    background: rgba(0,0,0,0.88);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 16px;
  }
  #camPermOverlay.hidden { display: none; }
  .perm-box {
    background: linear-gradient(135deg,#0d0d2b,#1a1a4a);
    border: 2px solid var(--gold-dark); border-radius: 12px;
    padding: 32px 40px; text-align: center; max-width: 380px;
    box-shadow: 0 0 40px rgba(212,175,55,0.3);
  }
  .perm-icon { font-size: 48px; margin-bottom: 12px; }
  .perm-title { font-family:'Cinzel Decorative',serif; color:var(--gold-light); font-size:15px; letter-spacing:2px; margin-bottom:10px; }
  .perm-desc { font-size:13px; color:rgba(255,255,255,0.7); line-height:1.6; margin-bottom:20px; }
  .perm-allow-btn {
    background: linear-gradient(to right,var(--gold-dark),var(--gold),var(--gold-dark));
    color: var(--dark-red); border: none; padding: 10px 30px;
    font-family:'Philosopher',serif; font-weight:700; font-size:14px;
    cursor: pointer; border-radius:6px; letter-spacing:2px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.4); transition: transform 0.15s;
    display: block; width: 100%;
  }
  .perm-allow-btn:hover { transform: scale(1.04); }
  .perm-skip { font-size:11px; color:rgba(255,255,255,0.35); cursor:pointer; margin-top:8px; text-decoration:underline; }
  .perm-skip:hover { color:rgba(255,255,255,0.6); }

  /* CAMERA QUIZ OVERLAY */
  #cameraQuiz {
    position: absolute; inset: 0; z-index: 50;
    background: #0a0a1a;
    display: none;
    flex-direction: column;
    overflow: hidden;
  }
  #cameraQuiz.active { display: flex; }
  .quiz-header {
    background: linear-gradient(to right, #0d0d2b, #1a1a4a, #0d0d2b);
    border-bottom: 2px solid var(--gold-dark);
    padding: 8px 18px;
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0;
  }
  .quiz-title { font-family:'Cinzel Decorative',serif; color:var(--gold-light); font-size:13px; letter-spacing:3px; }
  .quiz-back-btn {
    background: linear-gradient(to right,var(--gold-dark),var(--gold),var(--gold-dark));
    color: var(--dark-red); border:none; padding:6px 16px;
    font-family:'Philosopher',serif; font-weight:700; font-size:11px;
    cursor:pointer; border-radius:3px; letter-spacing:1px; transition:transform 0.15s;
  }
  .quiz-back-btn:hover{transform:scale(1.05);}
  .quiz-body {
    flex: 1; display: flex; gap: 0; overflow: hidden; position: relative;
  }
  /* PIP Camera - fixed g√≥c d∆∞·ªõi ph·∫£i m√†n h√¨nh th·∫≠t, ngo√†i scene */
  .camera-pip {
    position: fixed;
    bottom: 18px; right: 18px;
    width: 200px; height: 150px;
    border-radius: 12px;
    border: 2px solid var(--gold);
    overflow: hidden;
    box-shadow: 0 6px 30px rgba(0,0,0,0.8), 0 0 16px rgba(212,175,55,0.4);
    z-index: 9999;
    background: #000;
  }
  .camera-pip-label {
    position: absolute; top: 4px; left: 6px;
    background: rgba(0,0,0,0.7); color: var(--gold-light);
    font-size: 8px; padding: 2px 6px; border-radius: 4px;
    font-family:'Philosopher',serif; letter-spacing:1px; z-index:2; pointer-events:none;
  }
  #camVideo { width:100%; height:100%; object-fit:cover; transform:scaleX(-1); display:block; }
  #camCanvas { position:absolute; top:0;left:0; width:100%;height:100%; transform:scaleX(-1); pointer-events:none; }
  .cam-status {
    position:absolute; bottom:6px; left:50%; transform:translateX(-50%);
    background:rgba(0,0,0,0.8); color:var(--gold-light); font-size:8px;
    padding:2px 7px; border-radius:8px; white-space:nowrap;
    font-family:'Philosopher',serif; letter-spacing:0.5px; border:1px solid var(--gold-dark);
    z-index: 3;
  }
  /* Cursor dot - fixed theo m√†n h√¨nh, lerp x·ª≠ l√Ω b·∫±ng JS */
  .hand-cursor {
    position:fixed; width:28px;height:28px;
    border-radius:50%; background:rgba(255,215,0,0.75);
    border:3px solid #fff; pointer-events:none;
    transform:translate(-50%,-50%);
    box-shadow:0 0 16px rgba(255,215,0,1), 0 0 6px rgba(255,150,0,0.8);
    z-index:10000; display:none;
    will-change: left, top;
  }
  /* Quiz side */
  .quiz-side {
    flex:1; display:flex; flex-direction:column; padding:16px 20px; gap:12px;
    overflow: hidden;
  }
  .quiz-progress {
    display:flex; gap:6px; align-items:center;
  }
  .progress-dot {
    width:10px;height:10px;border-radius:50%;
    background:rgba(255,255,255,0.2); border:1px solid var(--gold-dark);
    transition:background 0.3s;
  }
  .progress-dot.done { background:var(--gold); }
  .progress-dot.active { background:var(--gold-light); box-shadow:0 0 6px var(--gold-light); }
  .quiz-question-box {
    background: linear-gradient(135deg,#111133,#1a1a4a);
    border:1px solid var(--gold-dark); border-radius:8px;
    padding:14px 16px; flex-shrink:0;
  }
  .quiz-q-num { font-size:10px; color:var(--gold-dark); letter-spacing:3px; font-family:'Cinzel Decorative',serif; margin-bottom:6px; }
  .quiz-q-text { font-size:15px; color:#fff; font-weight:700; line-height:1.4; }
  .quiz-options { display:grid; grid-template-columns:1fr 1fr; gap:10px; flex:1; }
  .quiz-option {
    background: linear-gradient(135deg,#1a1a3a,#22224a);
    border: 2px solid rgba(212,175,55,0.3); border-radius:8px;
    padding:10px 12px; cursor:pointer; display:flex; align-items:center; gap:8px;
    transition: border-color 0.2s, background 0.2s, transform 0.15s;
    position:relative; overflow:hidden;
  }
  .quiz-option:hover { border-color:var(--gold); transform:scale(1.02); }
  .quiz-option.hovered {
    border-color:var(--gold-light);
    background:linear-gradient(135deg,#2a2a5a,#3a3a7a);
    box-shadow:0 0 15px rgba(255,215,0,0.3);
  }
  .quiz-option.selected-correct {
    border-color:#00cc66; background:linear-gradient(135deg,#0a2a1a,#0d3d22);
    box-shadow:0 0 15px rgba(0,200,100,0.4);
  }
  .quiz-option.selected-wrong {
    border-color:#cc3300; background:linear-gradient(135deg,#2a0a0a,#3d0d0d);
    box-shadow:0 0 15px rgba(200,50,0,0.4);
  }
  .quiz-option.reveal-correct {
    border-color:#00cc66; background:linear-gradient(135deg,#0a2a1a,#0d3d22);
  }
  .opt-letter {
    width:26px;height:26px; border-radius:50%; flex-shrink:0;
    background:var(--gold-dark); color:var(--dark-red);
    font-family:'Cinzel Decorative',serif; font-size:11px; font-weight:900;
    display:flex;align-items:center;justify-content:center;
  }
  .opt-text { font-size:12px; color:#e0e0ff; line-height:1.3; }
  /* Confirm bar */
  .confirm-bar {
    flex-shrink:0; display:flex; align-items:center; justify-content:flex-end; gap:10px;
    padding:6px 0;
  }
  .confirm-btn {
    background:linear-gradient(to right,#224422,#338833,#224422);
    color:#aeffae; border:1px solid #55aa55;
    padding:7px 18px; font-family:'Philosopher',serif; font-weight:700;
    font-size:12px; cursor:pointer; border-radius:4px;
    transition:transform 0.15s, opacity 0.2s; opacity:0.4;
  }
  .confirm-btn.ready { opacity:1; }
  .confirm-btn:hover.ready{transform:scale(1.05);}
  /* hold progress ring */
  .hold-ring {
    position:absolute; inset:0; pointer-events:none; border-radius:8px;
    background: conic-gradient(rgba(255,215,0,0.6) var(--prog,0%), transparent 0%);
    opacity:0; transition:opacity 0.2s;
  }
  .hold-ring.active { opacity:1; }
  /* Summary */
  .quiz-summary {
    display:none; flex-direction:column; align-items:center; justify-content:center;
    flex:1; text-align:center; padding:20px;
    animation:fadeIn 0.5s ease;
  }
  .quiz-summary.active { display:flex; }
  @keyframes fadeIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
  .summary-title { font-family:'Cinzel Decorative',serif; color:var(--gold-light); font-size:18px; margin-bottom:10px; }
  .summary-score { font-size:48px; color:#fff; font-weight:900; margin:10px 0; }
  .summary-score span { color:var(--gold); }
  .summary-items { display:flex; flex-direction:column; gap:6px; width:100%; max-width:380px; margin:10px 0; }
  .summary-item { display:flex; align-items:center; gap:8px; background:rgba(255,255,255,0.05); border-radius:6px; padding:8px 12px; border:1px solid rgba(212,175,55,0.2); }
  .summary-item .s-icon { font-size:16px; flex-shrink:0; }
  .summary-item .s-text { font-size:11px; color:#ccc; text-align:left; line-height:1.3; }
  .summary-item .s-ans { font-size:11px; font-weight:700; margin-left:auto; padding:2px 8px; border-radius:4px; }
  .s-correct .s-ans { color:#afffaf; background:rgba(0,150,60,0.3); }
  .s-wrong .s-ans { color:#ffafaf; background:rgba(150,0,0,0.3); }
  .summary-msg { font-size:13px; color:var(--gold-light); font-style:italic; margin-top:10px; }
  .summary-restart { margin-top:14px; background:linear-gradient(to right,var(--gold-dark),var(--gold),var(--gold-dark)); color:var(--dark-red); border:none; padding:9px 24px; font-family:'Philosopher',serif; font-weight:700; font-size:13px; cursor:pointer; border-radius:4px; letter-spacing:1px; transition:transform 0.15s; }
  .summary-restart:hover{transform:scale(1.05);}

  /* SPARKLES */
  .sparkle { position:absolute; border-radius:50%; animation:sparkleFly 1s ease-out forwards; opacity:0; z-index:19; pointer-events:none; }
  @keyframes sparkleFly { 0%{opacity:1;transform:scale(1) translate(0,0);}100%{opacity:0;transform:scale(0.3) translate(var(--tx),var(--ty));} }

  /* PARTICLES */
  .particles{position:absolute;inset:0;pointer-events:none;z-index:7;}
  .particle{position:absolute;border-radius:50%;background:var(--gold-light);animation:particleFloat linear infinite;opacity:0;}
  @keyframes particleFloat{0%{opacity:0;transform:translateY(0);}20%{opacity:0.6;}80%{opacity:0.2;}100%{opacity:0;transform:translateY(-180px);}}

  .table-glow{position:absolute;bottom:210px;left:50%;transform:translateX(-50%);width:240px;height:30px;background:radial-gradient(ellipse,rgba(255,180,80,0.15),transparent 70%);z-index:10;pointer-events:none;}

  /* ‚îÄ‚îÄ S·ªî THI√äN M·ªÜNH BUTTON ‚îÄ‚îÄ */
  #soThienMenhBtn {
    position: fixed; top: 14px; left: 14px;
    z-index: 8000;
    width: 46px; height: 46px; border-radius: 50%;
    background: linear-gradient(135deg, var(--gold-dark), var(--gold), var(--gold-dark));
    border: 2px solid var(--gold-light);
    box-shadow: 0 0 18px rgba(212,175,55,0.6), 0 4px 12px rgba(0,0,0,0.5);
    cursor: pointer; font-size: 22px;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  #soThienMenhBtn:hover { transform: scale(1.12); box-shadow: 0 0 28px rgba(212,175,55,0.9); }

  /* ‚îÄ‚îÄ MODAL S·ªî THI√äN M·ªÜNH ‚îÄ‚îÄ */
  #soThienMenhModal {
    display: none; position: fixed; inset: 0; z-index: 9000;
    background: rgba(0,0,0,0.82);
    align-items: center; justify-content: center;
  }
  #soThienMenhModal.open { display: flex; }
  .so-modal-box {
    width: 680px; max-height: 82vh;
    background: linear-gradient(160deg, #f5e6c0 0%, #ede0aa 30%, #e8d48a 60%, #f0e0b0 100%);
    border-radius: 6px;
    border: 3px solid var(--gold-dark);
    box-shadow: 0 0 60px rgba(0,0,0,0.7), inset 0 0 40px rgba(180,130,40,0.15);
    position: relative; overflow: hidden; display: flex; flex-direction: column;
    background-image:
      linear-gradient(160deg, #f5e6c0 0%, #ede0aa 30%, #e8d48a 60%, #f0e0b0 100%),
      url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  }
  .so-modal-box::before {
    content: ''; position: absolute; inset: 0; pointer-events: none;
    background: repeating-linear-gradient(0deg, transparent 0, transparent 22px, rgba(139,100,30,0.08) 23px);
  }
  .so-header {
    padding: 18px 24px 12px;
    border-bottom: 2px solid rgba(139,100,30,0.4);
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0;
  }
  .so-title {
    font-family: 'Cinzel Decorative', serif;
    font-size: 17px; color: var(--dark-red);
    text-shadow: 1px 1px 0 rgba(212,175,55,0.4);
    letter-spacing: 2px;
  }
  .so-close-btn {
    background: var(--dark-red); color: var(--gold-light);
    border: 1px solid var(--gold-dark); width: 32px; height: 32px;
    border-radius: 50%; font-size: 16px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.15s;
  }
  .so-close-btn:hover { transform: scale(1.1); }
  .so-desc {
    padding: 8px 24px 10px;
    font-size: 12px; color: #6B3A2A; font-style: italic;
    border-bottom: 1px solid rgba(139,100,30,0.2);
    flex-shrink: 0;
  }
  /* S·ªë d·ªçc: c·ªôt 1 = 1-10, c·ªôt 2 = 11-20, c·ªôt 3 = 21-30, c·ªôt 4 = 31-40 */
  .so-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(10, auto);
    grid-auto-flow: column;
    gap: 6px 12px; padding: 14px 18px;
    overflow-y: auto; flex: 1;
  }
  .so-grid::-webkit-scrollbar { width: 6px; }
  .so-grid::-webkit-scrollbar-track { background: rgba(139,100,30,0.1); }
  .so-grid::-webkit-scrollbar-thumb { background: var(--gold-dark); border-radius: 3px; }
  .so-item {
    display: flex; align-items: center; gap: 5px;
  }
  .so-num {
    font-family: 'Cinzel Decorative', serif;
    font-size: 10px; color: var(--gold-dark);
    min-width: 20px; text-align: right; flex-shrink: 0;
  }
  .so-input {
    flex: 1; background: rgba(255,255,255,0.45);
    border: 1px solid rgba(139,100,30,0.35);
    border-radius: 4px; padding: 5px 7px;
    font-family: 'Philosopher', serif; font-size: 12px;
    color: var(--dark-red); outline: none;
    transition: border-color 0.2s, background 0.2s;
  }
  .so-input:focus { border-color: var(--gold-dark); background: rgba(255,255,255,0.7); }
  .so-input::placeholder { color: rgba(92,0,0,0.35); font-style: italic; }
  .so-footer {
    padding: 12px 24px; border-top: 2px solid rgba(139,100,30,0.4);
    display: flex; align-items: center; gap: 12px; flex-shrink: 0;
  }
  .so-count { font-size: 12px; color: #6B3A2A; font-style: italic; flex: 1; }
  .so-save-btn {
    background: linear-gradient(to right, var(--dark-red), #8b1a1a, var(--dark-red));
    color: var(--gold-light); border: 1px solid var(--gold-dark);
    padding: 8px 22px; font-family: 'Philosopher', serif; font-weight: 700;
    font-size: 12px; letter-spacing: 2px; cursor: pointer; border-radius: 4px;
    transition: transform 0.15s;
  }
  .so-save-btn:hover { transform: scale(1.04); }
  .so-clear-btn {
    background: transparent; color: rgba(92,0,0,0.5);
    border: 1px solid rgba(92,0,0,0.25); padding: 8px 14px;
    font-family: 'Philosopher', serif; font-size: 11px;
    cursor: pointer; border-radius: 4px; transition: all 0.15s;
  }
  .so-clear-btn:hover { background: rgba(92,0,0,0.1); color: var(--dark-red); }

  /* ‚îÄ‚îÄ K·∫æT QU·∫¢ GIEO QU·∫∫ M·ªû R·ªòNG ‚îÄ‚îÄ */
  .scroll-que-result {
    font-family: 'Cinzel Decorative', serif; font-size: 11px;
    color: var(--gold-dark); margin: 6px 0 2px; letter-spacing: 1px;
  }
  .scroll-que-name {
    font-family: 'Cinzel Decorative', serif; font-size: 15px; font-weight: 900;
    color: #7a1a00; text-shadow: 1px 1px 0 rgba(212,175,55,0.5);
    margin: 2px 0;
  }
  .scroll-que-desc {
    font-family: 'Philosopher', serif; font-style: italic;
    font-size: 11px; color: #5a3010; line-height: 1.5; margin-top: 4px;
  }
  .scroll-divider {
    height: 1px; background: linear-gradient(to right, transparent, var(--gold-dark), transparent);
    margin: 8px 0;
  }

  /* ‚îÄ‚îÄ S·ªî B√ÄI T·∫¨P BUTTON ‚îÄ‚îÄ */
  #soBaiTapBtn {
    position: fixed; top: 68px; left: 14px;
    z-index: 8000;
    width: 46px; height: 46px; border-radius: 50%;
    background: linear-gradient(135deg, #1a3a6a, #2255aa, #1a3a6a);
    border: 2px solid #6699ff;
    box-shadow: 0 0 18px rgba(50,100,220,0.5), 0 4px 12px rgba(0,0,0,0.5);
    cursor: pointer; font-size: 22px;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  #soBaiTapBtn:hover { transform: scale(1.12); box-shadow: 0 0 28px rgba(80,140,255,0.8); }

  /* ‚îÄ‚îÄ MODAL S·ªî B√ÄI T·∫¨P ‚îÄ‚îÄ */
  #soBaiTapModal {
    display: none; position: fixed; inset: 0; z-index: 9000;
    background: rgba(0,0,0,0.85);
    align-items: center; justify-content: center;
  }
  #soBaiTapModal.open { display: flex; }
  .sbt-modal-box {
    width: 760px; max-height: 86vh;
    background: linear-gradient(160deg, #f5e6c0 0%, #ede0aa 30%, #e8d48a 60%, #f0e0b0 100%);
    border-radius: 6px; border: 3px solid #5577cc;
    box-shadow: 0 0 60px rgba(0,0,0,0.7), inset 0 0 40px rgba(40,80,180,0.08);
    position: relative; overflow: hidden; display: flex; flex-direction: column;
  }
  .sbt-modal-box::before {
    content: ''; position: absolute; inset: 0; pointer-events: none;
    background: repeating-linear-gradient(0deg, transparent 0, transparent 22px, rgba(30,60,139,0.06) 23px);
  }
  .sbt-header {
    padding: 16px 24px 12px;
    border-bottom: 2px solid rgba(30,60,139,0.3);
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0; background: rgba(255,255,255,0.15);
  }
  .sbt-title {
    font-family: 'Cinzel Decorative', serif;
    font-size: 16px; color: #1a3a6a;
    letter-spacing: 2px;
  }
  .sbt-close-btn {
    background: #1a3a6a; color: #aaccff;
    border: 1px solid #4466bb; width: 32px; height: 32px;
    border-radius: 50%; font-size: 16px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.15s;
  }
  .sbt-close-btn:hover { transform: scale(1.1); }

  /* TABS */
  .sbt-tabs {
    display: flex; border-bottom: 2px solid rgba(30,60,139,0.25);
    flex-shrink: 0; background: rgba(255,255,255,0.1);
  }
  .sbt-tab {
    padding: 9px 20px; cursor: pointer;
    font-family: 'Philosopher', serif; font-size: 13px; font-weight: 700;
    color: rgba(26,58,106,0.5); border-bottom: 3px solid transparent;
    transition: all 0.2s; user-select: none;
  }
  .sbt-tab.active { color: #1a3a6a; border-bottom-color: #2255aa; }
  .sbt-tab:hover { color: #2255aa; background: rgba(255,255,255,0.2); }

  /* TAB CONTENT */
  .sbt-tab-panel { display: none; flex: 1; flex-direction: column; overflow: hidden; min-height: 0; }
  .sbt-tab-panel.active { display: flex; }

  /* INPUT PANEL */
  .sbt-input-area { flex: 1; display: flex; flex-direction: column; gap: 10px; padding: 14px 20px; overflow: hidden; }
  .sbt-textarea {
    flex: 1; resize: none; min-height: 200px;
    background: rgba(255,255,255,0.55); border: 1px solid rgba(30,60,139,0.3);
    border-radius: 6px; padding: 12px 14px;
    font-family: 'Philosopher', serif; font-size: 13px;
    color: #1a2a50; line-height: 1.6; outline: none;
    transition: border-color 0.2s, background 0.2s;
  }
  .sbt-textarea:focus { border-color: #2255aa; background: rgba(255,255,255,0.75); }
  .sbt-textarea::placeholder { color: rgba(26,58,106,0.4); font-style: italic; }
  .sbt-input-hint {
    font-size: 11px; color: #5a3a10; font-style: italic; line-height: 1.5;
    background: rgba(255,220,100,0.3); border-radius: 4px; padding: 6px 10px;
    border-left: 3px solid var(--gold-dark); flex-shrink: 0;
  }
  .sbt-parse-btn {
    background: linear-gradient(to right, #1a3a6a, #2255aa, #1a3a6a);
    color: #aaccff; border: 1px solid #4466bb;
    padding: 10px 24px; font-family: 'Philosopher', serif; font-weight: 700;
    font-size: 13px; cursor: pointer; border-radius: 5px;
    transition: transform 0.15s; letter-spacing: 1px; flex-shrink: 0;
  }
  .sbt-parse-btn:hover { transform: scale(1.03); }
  .sbt-parse-result {
    font-size: 12px; color: #1a3a6a; font-style: italic; flex-shrink: 0;
    min-height: 18px;
  }

  /* QUESTION LIST PANEL */
  .sbt-qlist { flex: 1; overflow-y: auto; padding: 10px 16px; display: flex; flex-direction: column; gap: 10px; }
  .sbt-qlist::-webkit-scrollbar { width: 6px; }
  .sbt-qlist::-webkit-scrollbar-thumb { background: #4466bb; border-radius: 3px; }
  .sbt-q-card {
    background: rgba(255,255,255,0.5); border: 1px solid rgba(30,60,139,0.25);
    border-radius: 6px; padding: 10px 14px; position: relative;
  }
  .sbt-q-del {
    position: absolute; top: 8px; right: 8px;
    width: 26px; height: 26px; border-radius: 50%;
    background: rgba(180,30,30,0.15); border: 1px solid rgba(180,30,30,0.4);
    color: #aa2200; font-size: 13px; line-height: 26px; text-align: center;
    cursor: pointer; transition: background 0.15s;
    user-select: none; flex-shrink: 0;
  }
  .sbt-q-del:hover, .sbt-q-del:active { background: rgba(180,30,30,0.35); }
  .sbt-q-num { font-family: 'Cinzel Decorative', serif; font-size: 10px; color: #2255aa; margin-bottom: 4px; }
  .sbt-q-text { font-size: 13px; color: #1a2a50; font-weight: 700; margin-bottom: 6px; line-height: 1.4; }
  .sbt-q-opts { display: grid; grid-template-columns: 1fr 1fr; gap: 3px 10px; }
  .sbt-q-opt { font-size: 11px; color: #3a4a70; }
  .sbt-q-opt.correct { color: #006622; font-weight: 700; }
  .sbt-q-opt.correct::before { content: '‚úì '; }

  /* FOOTER */
  .sbt-footer {
    padding: 10px 20px; border-top: 2px solid rgba(30,60,139,0.25);
    display: flex; align-items: center; gap: 10px; flex-shrink: 0;
    background: rgba(255,255,255,0.1);
  }
  .sbt-stat { font-size: 12px; color: #1a3a6a; font-style: italic; flex: 1; }
  .sbt-clear-btn {
    background: transparent; color: rgba(26,58,106,0.5);
    border: 1px solid rgba(26,58,106,0.25); padding: 7px 14px;
    font-family: 'Philosopher', serif; font-size: 11px;
    cursor: pointer; border-radius: 4px; transition: all 0.15s;
  }
  .sbt-clear-btn:hover { background: rgba(26,58,106,0.1); color: #1a3a6a; }
</style>
</head>
<body>
<!-- S·ªî THI√äN M·ªÜNH BUTTON (fixed top-left) -->
<button id="soThienMenhBtn" onclick="openSo()" title="S·ªï Thi√™n M·ªánh">üìú</button>

<!-- S·ªî THI√äN M·ªÜNH MODAL -->
<div id="soThienMenhModal">
  <div class="so-modal-box">
    <div class="so-header">
      <span class="so-title">üìú S·ªï Thi√™n M·ªánh</span>
      <button class="so-close-btn" onclick="closeSo()">‚úï</button>
    </div>
    <div class="so-desc">‚ú¶ Nh·∫≠p t√™n t·ªëi ƒëa 40 ng∆∞·ªùi ‚Äî H·ªá th·ªëng s·∫Ω b·ªëc thƒÉm ng·∫´u nhi√™n khi gieo qu·∫ª ‚ú¶</div>
    <div class="so-grid" id="soGrid"></div>
    <div class="so-footer">
      <span class="so-count" id="soCount">0 / 40 t√™n ƒë√£ nh·∫≠p</span>
      <button class="so-clear-btn" onclick="clearSo()">Xo√° t·∫•t c·∫£</button>
      <button class="so-save-btn" onclick="saveSo()">üíæ L∆∞u S·ªï</button>
    </div>
  </div>
</div>

<!-- S·ªî B√ÄI T·∫¨P BUTTON -->
<button id="soBaiTapBtn" onclick="openSbt()" title="S·ªï B√†i T·∫≠p Th√¥ng Minh">üìñ</button>

<!-- S·ªî B√ÄI T·∫¨P MODAL -->
<div id="soBaiTapModal">
  <div class="sbt-modal-box">
    <div class="sbt-header">
      <span class="sbt-title">üìñ S·ªï B√†i T·∫≠p Th√¥ng Minh</span>
      <button class="sbt-close-btn" onclick="closeSbt()">‚úï</button>
    </div>
    <div class="sbt-tabs">
      <div class="sbt-tab active" id="sbtTab0" onclick="switchSbtTab(0)">üìã D√°n N·ªôi Dung</div>
      <div class="sbt-tab" id="sbtTab1" onclick="switchSbtTab(1)">üìö Ng√¢n H√†ng C√¢u H·ªèi</div>
    </div>
    <!-- Tab 0: Input -->
    <div class="sbt-tab-panel active" id="sbtPanel0">
      <div class="sbt-input-area">
        <div class="sbt-input-hint">
          ‚ú¶ D√°n n·ªôi dung tr·∫Øc nghi·ªám v√†o ƒë√¢y. M·ªói c√¢u h·ªèi <strong>c√°ch nhau b·∫±ng 1 d√≤ng tr·∫Øng</strong>.<br>
          <strong>C√¢u h·ªèi:</strong> "C√¢u 1:", "C√¢u 1.", "1." &nbsp;|&nbsp; <strong>ƒê√°p √°n A/B/C/D:</strong> m·ªói d√≤ng ri√™ng <em>ho·∫∑c</em> c√°ch nhau b·∫±ng kho·∫£ng tr·∫Øng &nbsp;|&nbsp; <strong>ƒê√°p √°n ƒë√∫ng:</strong> "ƒê√°p √°n: A"
        </div>
        <textarea class="sbt-textarea" id="sbtRawText" placeholder="D√°n n·ªôi dung b√†i t·∫≠p tr·∫Øc nghi·ªám v√†o ƒë√¢y...&#10;&#10;V√≠ d·ª•:&#10;C√¢u 1. Th·ªß ƒë√¥ c·ªßa Vi·ªát Nam l√† g√¨?&#10;A. H√† N·ªôi&#10;B. H·ªì Ch√≠ Minh&#10;C. ƒê√† N·∫µng&#10;D. Hu·∫ø&#10;ƒê√°p √°n: A&#10;&#10;C√¢u 2. S√¥ng d√†i nh·∫•t VN?&#10;A. S√¥ng H·ªìng  B. S√¥ng Mekong  C. S√¥ng ƒê√†  D. S√¥ng M√£"></textarea>
        <button class="sbt-parse-btn" onclick="parseBaiTap()">‚ö° Ph√¢n T√≠ch D·ªØ Li·ªáu</button>
        <div class="sbt-parse-result" id="sbtParseResult"></div>
      </div>
    </div>
    <!-- Tab 1: Question bank -->
    <div class="sbt-tab-panel" id="sbtPanel1">
      <div class="sbt-qlist" id="sbtQList">
        <div style="text-align:center;color:rgba(26,58,106,0.4);font-style:italic;padding:40px 0;">Ch∆∞a c√≥ c√¢u h·ªèi n√†o. H√£y d√°n n·ªôi dung v√† ph√¢n t√≠ch!</div>
      </div>
    </div>
    <div class="sbt-footer">
      <span class="sbt-stat" id="sbtStat">0 c√¢u h·ªèi trong kho</span>
      <button class="sbt-clear-btn" id="sbtClearBtn" onclick="clearSbt()" style="display:none;">üóë Xo√° kho</button>
    </div>
  </div>
</div>

<div class="scene">
  <div class="wall-pattern"></div>
  <div class="top-border">‚ú¶ L·∫¶U TI√äN TRI ‚ú¶</div>
  <div class="particles" id="particles"></div>

  <!-- Lanterns -->
  <div class="lantern lantern-left">
    <div class="lantern-cord"></div><div class="lantern-top"></div>
    <div class="lantern-body"></div><div class="lantern-bottom"></div>
    <div class="lantern-glow"></div>
  </div>
  <div class="lantern lantern-right">
    <div class="lantern-cord"></div><div class="lantern-top"></div>
    <div class="lantern-body"></div><div class="lantern-bottom"></div>
    <div class="lantern-glow"></div>
  </div>

  <!-- Incense -->
  <div class="incense-container incense-left">
    <div class="smoke"><div class="smoke-puff"></div><div class="smoke-puff"></div><div class="smoke-puff"></div></div>
    <div class="incense-stick"></div>
  </div>
  <div class="incense-container incense-right">
    <div class="smoke"><div class="smoke-puff"></div><div class="smoke-puff"></div><div class="smoke-puff"></div></div>
    <div class="incense-stick"></div>
  </div>

  <!-- Fortune Teller -->
  <div class="fortune-teller">
    <svg class="character-svg" viewBox="0 0 180 230" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M35 170 Q90 155 145 170 L148 230 Q90 245 32 230 Z" fill="#111111"/>
      <path d="M55 172 Q90 162 125 172 L128 228 Q90 238 52 228 Z" fill="#1a1a1a"/>
      <path d="M80 168 Q90 160 100 168" stroke="#2a2a2a" stroke-width="2.5" fill="none"/>
      <rect x="81" y="140" width="18" height="28" rx="5" fill="#f0c8a0"/>
      <ellipse cx="90" cy="118" rx="36" ry="40" fill="#f0c8a0"/>
      <ellipse cx="90" cy="123" rx="32" ry="34" fill="#f2caa5"/>
      <ellipse cx="90" cy="83" rx="44" ry="11" fill="#1a1a1a"/>
      <rect x="58" y="48" width="64" height="38" rx="6" fill="#111111"/>
      <rect x="61" y="52" width="58" height="33" rx="4" fill="#1a1a1a"/>
      <rect x="61" y="77" width="58" height="8" fill="#1a3a1a"/>
      <ellipse cx="74" cy="112" rx="15" ry="11" fill="#050505"/>
      <ellipse cx="108" cy="112" rx="15" ry="11" fill="#050505"/>
      <rect x="88" y="109" width="5" height="5" rx="1" fill="#222"/>
      <ellipse cx="68" cy="108" rx="4" ry="2.5" fill="rgba(255,255,255,0.08)"/>
      <ellipse cx="102" cy="108" rx="4" ry="2.5" fill="rgba(255,255,255,0.08)"/>
      <ellipse cx="74" cy="112" rx="15" ry="11" fill="none" stroke="#444" stroke-width="2"/>
      <ellipse cx="108" cy="112" rx="15" ry="11" fill="none" stroke="#444" stroke-width="2"/>
      <line x1="58" y1="112" x2="44" y2="114" stroke="#444" stroke-width="2"/>
      <line x1="123" y1="112" x2="137" y2="114" stroke="#444" stroke-width="2"/>
      <path d="M78 128 Q85 134 90 130 Q95 134 102 128" stroke="#111" stroke-width="3.5" fill="none" stroke-linecap="round"/>
      <ellipse cx="54" cy="118" rx="7" ry="10" fill="#e8b898"/>
      <ellipse cx="126" cy="118" rx="7" ry="10" fill="#e8b898"/>
      <path d="M35 195 Q50 185 68 190 L70 210 Q52 215 35 205 Z" fill="#111"/>
      <path d="M145 195 Q130 185 112 190 L110 210 Q128 215 145 205 Z" fill="#111"/>
      <ellipse cx="58" cy="210" rx="16" ry="9" fill="#f0c8a0"/>
      <ellipse cx="122" cy="210" rx="16" ry="9" fill="#f0c8a0"/>
    </svg>
  </div>

  <!-- TABLE -->
  <div class="table">
    <div class="table-surface"></div>
    <div class="table-grain"></div>
    <div class="table-leg table-leg-left"></div>
    <div class="table-leg table-leg-right"></div>
  </div>
  <div class="table-glow"></div>

  <!-- CUP + STICKS -->
  <div class="cup-area" id="cupArea" onclick="rollDice()">
    <div class="sticks-group" id="sticksGroup">
      <div class="stick" style="left:7px;height:35px;transform:rotate(-14deg)"></div>
      <div class="stick" style="left:14px;height:39px;transform:rotate(-7deg)"></div>
      <div class="stick" style="left:21px;height:32px;transform:rotate(-1deg)"></div>
      <div class="stick" style="left:28px;height:37px;transform:rotate(6deg)"></div>
      <div class="stick" style="left:35px;height:30px;transform:rotate(12deg)"></div>
      <div class="stick" style="left:43px;height:34px;transform:rotate(17deg)"></div>
      <div class="stick" style="left:17px;height:41px;transform:rotate(-10deg)"></div>
      <div class="stick" style="left:32px;height:28px;transform:rotate(20deg)"></div>
    </div>

    <svg class="cup-svg" viewBox="0 0 62 70" fill="none" xmlns="http://www.w3.org/2000/svg">
      <ellipse cx="31" cy="67" rx="22" ry="4" fill="rgba(0,0,0,0.3)"/>
      <path d="M8 10 L12 62 Q31 68 50 62 L54 10 Z" fill="url(#cupGrad)"/>
      <ellipse cx="31" cy="10" rx="23" ry="6" fill="url(#rimGrad)"/>
      <path d="M12 18 L14 55 Q18 58 22 57 L20 20 Z" fill="rgba(255,255,255,0.1)"/>
      <rect x="16" y="26" width="30" height="24" rx="4" fill="rgba(0,0,0,0.15)"/>
      <defs>
        <linearGradient id="cupGrad" x1="8" y1="0" x2="54" y2="0" gradientUnits="userSpaceOnUse">
          <stop offset="0%" stop-color="#b07820"/>
          <stop offset="30%" stop-color="#d4a040"/>
          <stop offset="60%" stop-color="#e8bc58"/>
          <stop offset="100%" stop-color="#b07820"/>
        </linearGradient>
        <linearGradient id="rimGrad" x1="8" y1="0" x2="54" y2="0" gradientUnits="userSpaceOnUse">
          <stop offset="0%" stop-color="#9e7e1a"/>
          <stop offset="50%" stop-color="#D4AF37"/>
          <stop offset="100%" stop-color="#9e7e1a"/>
        </linearGradient>
      </defs>
    </svg>
    <div class="cup-label">Xin<br>Qu·∫ª?</div>
  </div>

  <!-- RESULT SCROLL -->
  <div class="result-scroll" id="resultScroll">
    <div id="sparkleContainer" style="position:absolute;inset:-60px;pointer-events:none;z-index:1;"></div>
    <div class="scroll-wrapper">
      <div class="scroll-roll-left"></div>
      <div class="scroll-content">
        <div class="scroll-inner">
          <div class="scroll-left-col">
            <div class="scroll-label">‚ú¶ Th√≠ ch·ªß ƒë∆∞·ª£c ch·ªçn ‚ú¶</div>
            <div class="scroll-name" id="resultName">Nguy·ªÖn VƒÉn A</div>
            <div class="scroll-que-result" id="resultQueName">‚ú¶ Qu·∫ª: ƒê·∫°i C√°t ‚ú¶</div>
          </div>
          <div class="scroll-right-col">
            <div class="scroll-que-name" id="resultQueTitle">ƒê·∫†I C√ÅT</div>
            <div class="scroll-sub" id="resultSub">V·∫≠n may ƒëang ƒë·∫øn!</div>
          </div>
        </div>
      </div>
      <div class="scroll-roll-right"></div>
    </div>
    <div class="scroll-btn-row">
      <button class="scroll-close" onclick="closeScroll()">‚ú¶ Gieo l·∫°i ‚ú¶</button>
      <button class="scroll-quiz-btn" onclick="openCameraQuiz()">üçÄ Ch√∫c em may m·∫Øn ‚ñ∂</button>
    </div>
  </div>

  <!-- QUIZ OVERLAY -->
  <div id="cameraQuiz">
    <div class="quiz-header">
      <span class="quiz-title">‚ú¶ TH·ª¨ TH√ÅCH TRI TH·ª®C ‚ú¶</span>
      <button class="quiz-back-btn" onclick="closeCameraQuiz()">‚óÄ Quay l·∫°i Gieo Qu·∫ª</button>
    </div>
    <div class="quiz-body">
      <div class="quiz-side">
        <div class="quiz-progress">
          <div class="progress-dot active" id="dot0"></div>
          <div class="progress-dot" id="dot1"></div>
          <div class="progress-dot" id="dot2"></div>
          <span style="margin-left:6px;font-size:10px;color:var(--gold-dark);letter-spacing:2px;">C√ÇU H·ªéI</span>
        </div>
        <div class="quiz-question-box">
          <div class="quiz-q-num" id="qNum">C√ÇU 1 / 3</div>
          <div class="quiz-q-text" id="qText">ƒêang t·∫£i c√¢u h·ªèi...</div>
        </div>
        <div class="quiz-options" id="quizOptions">
          <div class="quiz-option" id="opt0" onclick="selectOption(0)"><div class="hold-ring" id="ring0"></div><div class="opt-letter">A</div><div class="opt-text" id="optText0"></div></div>
          <div class="quiz-option" id="opt1" onclick="selectOption(1)"><div class="hold-ring" id="ring1"></div><div class="opt-letter">B</div><div class="opt-text" id="optText1"></div></div>
          <div class="quiz-option" id="opt2" onclick="selectOption(2)"><div class="hold-ring" id="ring2"></div><div class="opt-letter">C</div><div class="opt-text" id="optText2"></div></div>
          <div class="quiz-option" id="opt3" onclick="selectOption(3)"><div class="hold-ring" id="ring3"></div><div class="opt-letter">D</div><div class="opt-text" id="optText3"></div></div>
        </div>
                  <div class="confirm-bar">
          <button class="confirm-btn" id="confirmBtn" onclick="confirmAnswer()">‚úì X√°c nh·∫≠n</button>
        </div>
        <div class="quiz-summary" id="quizSummary">
          <div class="summary-title">‚ú¶ K·∫æT QU·∫¢ ‚ú¶</div>
          <div class="summary-score">ƒê√∫ng <span id="scoreNum">0</span>/3</div>
          <div class="summary-items" id="summaryItems"></div>
          <div class="summary-msg" id="summaryMsg"></div>
          <button class="summary-restart" onclick="closeCameraQuiz()">‚úì Ho√†n th√†nh</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ QU·∫∫ DATA (30 qu·∫ª) ‚îÄ‚îÄ
const queData = {
  // === TH∆Ø·ª¢NG C√ÅT ===
  'ƒê·∫°i C√°t':    { title:'ƒê·∫†I C√ÅT ‚ú®',    desc:'‚òÄÔ∏è V·∫≠n tr·ªùi ƒëang ·ªü ƒë·ªânh cao. S·ª± nghi·ªáp thƒÉng ti·∫øn, t√†i l·ªôc r·ªßng r·ªânh, t√¨nh duy√™n vi√™n m√£n. M·ªçi k·∫ø ho·∫°ch ra tay ƒë·ªÅu thu·∫≠n bu·ªìm ‚Äî ƒë√¢y l√† th·ªùi ƒëi·ªÉm v√†ng ƒë·ªÉ h√†nh ƒë·ªông!' },
  'Ph√∫c L·ªôc':  { title:'PH√öC L·ªòC üåü',   desc:'üçÄ Ph√∫c v√† L·ªôc song h√†nh. C√¥ng vi·ªác n·ªü hoa, gia ƒë√¨nh √™m ·∫•m, ti·ªÅn b·∫°c t·ª± nhi√™n t√¨m ƒë·∫øn. H√£y r·ªông tay chia s·∫ª ‚Äî cho ƒëi c√†ng nhi·ªÅu, ph√∫c l·∫°i c√†ng d√†y.' },
  'Thi√™n H·ª∑':  { title:'THI√äN H·ª∂ üéâ',   desc:'üéä Tin vui t·ª´ tr√™n tr·ªùi r∆°i xu·ªëng! S·∫Øp c√≥ s·ª± ki·ªán ƒë√°ng m·ª´ng ‚Äî thƒÉng ch·ª©c, h√¥n s·ª±, ho·∫∑c c∆° h·ªôi b·∫•t ng·ªù g√µ c·ª≠a. M·ªü r·ªông l√≤ng ƒë√≥n nh·∫≠n!' },
  'V∆∞·ª£ng T√†i': { title:'V∆Ø·ª¢NG T√ÄI üí∞',  desc:'üíé T√†i kh√≠ ƒëang v∆∞·ª£ng ph√°t. Th·ªùi ƒëi·ªÉm l√Ω t∆∞·ªüng ƒë·ªÉ ƒë·∫ßu t∆∞, m·ªü r·ªông kinh doanh. Ti·ªÅn v√†o nh∆∞ n∆∞·ªõc ‚Äî nh∆∞ng gi·ªØ ch·ªØ T√≠n l√†m g·ªëc r·ªÖ b·ªÅn v·ªØng.' },
  'Qu√Ω Nh√¢n':  { title:'QU√ù NH√ÇN ü§ù',   desc:'üå† M·ªôt qu√Ω nh√¢n s·∫Ω xu·∫•t hi·ªán tr√™n con ƒë∆∞·ªùng th√≠ ch·ªß, mang theo c∆° h·ªôi ho·∫∑c l·ªùi khuy√™n ƒë·ªïi ƒë·ªùi. H√£y ch√¢n th√†nh ‚Äî duy√™n l√†nh ƒë·∫øn m·ªôt l·∫ßn, ƒë·ª´ng b·ªè l·ª°.' },
  'C√¥ng Th√†nh': { title:'C√îNG TH√ÄNH üèÜ', desc:'üéñÔ∏è Th√†nh qu·∫£ x·ª©ng ƒë√°ng ƒëang ƒë·∫øn tay. Bao nhi√™u m·ªì h√¥i gi·ªù l√† l√∫c thu ho·∫°ch. T·ª± h√†o v·ªÅ ch·∫∑ng ƒë∆∞·ªùng ƒë√£ qua v√† ti·∫øp t·ª•c v∆∞∆°n l√™n t·∫ßm cao m·ªõi.' },
  // === TRUNG C√ÅT ===
  'Trung C√°t':  { title:'TRUNG C√ÅT üå§Ô∏è',  desc:'‚õÖ V·∫≠n ƒëang kh√° thu·∫≠n, c√≥ qu√Ω nh√¢n ng·∫ßm ph√π tr·ª£. Ch·ªâ c·∫ßn th√™m ch√∫t ki√™n tr√¨ l√† th√†nh c√¥ng g√µ c·ª≠a. ƒê·ª´ng n√¥n n√≥ng ‚Äî n∆∞·ªõc ch·∫£y ƒë√° m√≤n.' },
  'Ti·ªÉu C√°t':   { title:'TI·ªÇU C√ÅT üå±',   desc:'üåø V·∫≠n nh·ªè ƒëang thu·∫≠n l·ª£i. Chuy·ªán l·ªõn ch∆∞a ƒë·∫øn l√∫c, nh∆∞ng t·ª´ng b∆∞·ªõc nh·ªè ƒëang x√¢y n·ªÅn m√≥ng v·ªØng. T√≠ch l≈©y ki√™n nh·∫´n ‚Äî m√πa b·ªôi thu s·∫Øp ƒë·∫øn.' },
  'Xu√¢n Lai':   { title:'XU√ÇN LAI üå∏',   desc:'üå∫ M√πa xu√¢n ƒë·∫øn sau ƒë√¥ng d√†i. Giai ƒëo·∫°n kh√≥ khƒÉn ƒëang qua ƒëi, m·ªçi th·ª© b·∫Øt ƒë·∫ßu h·ªìi sinh v√† kh·ªüi s·∫Øc. H√£y gieo nh·ªØng h·∫°t m·∫ßm t·ªët ngay h√¥m nay.' },
  'C√°t Kh√°nh':  { title:'C√ÅT KH√ÅNH üòä',  desc:'üí´ L√†nh l·∫∑n v√† vui t∆∞∆°i bao ph·ªß. S·ª©c kh·ªèe t·ªët, tinh th·∫ßn ph·∫•n ch·∫•n, lo √¢u tan bi·∫øn. ƒê√¢y l√† qu√£ng th·ªùi gian b√¨nh y√™n ‚Äî h√£y t·∫≠n h∆∞·ªüng tr·ªçn v·∫πn.' },
  'H·ªçc T·∫•n':    { title:'H·ªåC T·∫§N üìö',    desc:'üîë Tri th·ª©c l√† ch√¨a kh√≥a l√∫c n√†y. ƒê·∫ßu t∆∞ v√†o h·ªçc h·ªèi, trau d·ªìi k·ªπ nƒÉng s·∫Ω mang l·∫°i l·ª£i √≠ch g·∫•p b·ªôi. M·ªói trang s√°ch h√¥m nay l√† m·ªôt c√°nh c·ª≠a t∆∞∆°ng lai.' },
  'H√≤a H·ª£p':   { title:'H√íA H·ª¢P ü§≤',    desc:'üåà M·ªçi m·ªëi quan h·ªá ƒëang thu·∫≠n h√≤a. Th·ªùi ƒëi·ªÉm v√†ng ƒë·ªÉ vun ƒë·∫Øp t√¨nh th√¢n, h·ª£p t√°c v√† m·ªü r·ªông m·∫°ng l∆∞·ªõi. ƒêo√†n k·∫øt ‚Äî ƒë√≥ l√† s·ª©c m·∫°nh l·ªõn nh·∫•t.' },
  // === B√åNH ===
  'B√¨nh':        { title:'B√åNH TH∆Ø·ªúNG ‚öñÔ∏è', desc:'üåä S√≥ng l·∫∑ng, gi√≥ √™m. Kh√¥ng ƒë·∫∑c bi·ªát t·ªët c≈©ng ch·∫≥ng x·∫•u ‚Äî ƒë√¢y l√† l√∫c duy tr√¨ ·ªïn ƒë·ªãnh, tr√°nh m·∫°o hi·ªÉm. Nh·∫´n n·∫°i ch·ªù th·ªùi, v·∫≠n s·∫Ω ƒë·ªïi thay.' },
  'B√¨nh An':    { title:'B√åNH AN üïäÔ∏è',    desc:'üåø M·ªçi s·ª± b√¨nh y√™n, kh√¥ng tai ∆∞∆°ng. H√£y t·∫≠n d·ª•ng kho·∫£ng l·∫∑ng n√†y ƒë·ªÉ ngh·ªâ ng∆°i, d∆∞·ª°ng s·ª©c v√† l√™n k·∫ø ho·∫°ch cho giai ƒëo·∫°n b·ª©t ph√° s·∫Øp t·ªõi.' },
  'Tƒ©nh T√¢m':   { title:'Tƒ®NH T√ÇM üßò',   desc:'üåô Bu√¥ng b·ªè ·ªìn √†o, l·∫Øng nghe ti·∫øng l√≤ng. C√¢u tr·∫£ l·ªùi b·∫°n ƒëang t√¨m kh√¥ng ·ªü b√™n ngo√†i ‚Äî n√≥ n·∫±m trong s·ª± tƒ©nh l·∫∑ng b√™n trong ch√≠nh m√¨nh.' },
  'Tr√¨ Ho√£n':  { title:'TR√å HO√ÉN ‚è≥',    desc:'üçÇ Th·ªùi c∆° ch∆∞a ch√≠n ‚Äî hoa n·ªü ƒë√∫ng m√πa m·ªõi ƒë·∫πp. T·∫°m g√°c k·∫ø ho·∫°ch l·ªõn, chu·∫©n b·ªã k·ªπ c√†ng h∆°n. Ng∆∞·ªùi bi·∫øt ch·ªù ƒë√∫ng l√∫c m·ªõi l√† ng∆∞·ªùi th·∫Øng sau c√πng.' },
  'Khi√™m T·ªën':  { title:'KHI√äM T·ªêN üåæ',  desc:'üéã C√¢y l√∫a ch√≠n c√∫i ƒë·∫ßu xu·ªëng ƒë·∫•t. Khi√™m t·ªën l√∫c n√†y kh√¥ng ph·∫£i y·∫øu ƒëu·ªëi ‚Äî ƒë√≥ l√† tr√≠ tu·ªá gi√∫p th√≠ ch·ªß ƒë∆∞·ª£c l√≤ng ng∆∞·ªùi v√† v∆∞·ª£t m·ªçi tr·ªü ng·∫°i.' },
  'Bi·∫øn ƒê·ªông':  { title:'BI·∫æN ƒê·ªòNG üåÄ',   desc:'üîÑ M·ªôt l√†n gi√≥ l·ªõn ƒëang ƒë·∫øn. Thay ƒë·ªïi kh√¥ng ƒë√°ng s·ª£ ‚Äî quan tr·ªçng l√† b·∫°n ƒë·ª©ng v·ªØng hay ng√£. Linh ho·∫°t th√≠ch nghi, gi·ªØ v·ªØng gi√° tr·ªã c·ªët l√µi.' },
  'T√°i Sinh':   { title:'T√ÅI SINH ü¶ã',    desc:'üåÖ Nh∆∞ b∆∞·ªõm tho√°t k√©n, m·ªôt phi√™n b·∫£n m·ªõi ƒëang ra ƒë·ªùi. D≈©ng c·∫£m bu√¥ng b·ªè c√°i c≈© ‚Äî c√°nh c·ª≠a ph√≠a tr∆∞·ªõc r·ªông h∆°n nhi·ªÅu so v·ªõi c√°nh c·ª≠a v·ª´a ƒë√≥ng.' },
  // === TI·ªÇU HUNG ===
  'Ti·ªÉu Hung':  { title:'TI·ªÇU HUNG ‚ö†Ô∏è',  desc:'üåßÔ∏è C√≥ ch√∫t tr·ªü ng·∫°i tr√™n ƒë∆∞·ªùng. C·∫©n l·ªùi n√≥i, c·∫©n h√†nh ƒë·ªông, tr√°nh xung ƒë·ªôt kh√¥ng c·∫ßn thi·∫øt. C∆°n m∆∞a nh·ªè r·ªìi c≈©ng t·∫°nh ‚Äî ki√™n nh·∫´n l√† ch√¨a kh√≥a.' },
  'C·∫ßn Th·∫≠n':  { title:'C·∫¶N TH·∫¨N üîç',    desc:'üê¢ Ch·∫≠m m√† ch·∫Øc th·∫Øng nhanh m√† h·ªèng. Kh√¥ng k√Ω k·∫øt, kh√¥ng quy·∫øt ƒë·ªãnh b·ªëc ƒë·ªìng l√∫c n√†y. H·ªèi ng∆∞·ªùi c√≥ kinh nghi·ªám tr∆∞·ªõc khi b∆∞·ªõc ‚Äî m·ªôt b∆∞·ªõc sai, trƒÉm b∆∞·ªõc l√πi.' },
  'Kh·∫©u Thi·ªát': { title:'KH·∫®U THI·ªÜT ü§ê', desc:'üîá H·ªça t·ª´ mi·ªáng m√† ra. Tr√°nh b√†n t√°n, tr√°nh tranh lu·∫≠n v√¥ √≠ch, tr√°nh k√Ω gi·∫•y t·ªù ch∆∞a ƒë·ªçc k·ªπ. L√∫c n√†y im l·∫∑ng c√≥ gi√° tr·ªã h∆°n ng√†n l·ªùi n√≥i.' },
};

// ‚îÄ‚îÄ S·ªî THI√äN M·ªÜNH ‚îÄ‚îÄ
const SO_KEY = 'soThienMenh_v1';
let soNames = Array(40).fill('');

async function loadSoFromStorage() {
  try {
    const result = await window.storage.get(SO_KEY, true);
    if (result && result.value) soNames = JSON.parse(result.value);
  } catch(e) { soNames = Array(40).fill(''); }
}

async function saveSo() {
  const inputs = document.querySelectorAll('.so-input');
  inputs.forEach((inp, i) => { soNames[i] = inp.value.trim(); });
  const btn = document.querySelector('.so-save-btn');
  btn.textContent = '‚è≥ ƒêang l∆∞u...';
  try {
    await window.storage.set(SO_KEY, JSON.stringify(soNames), true);
    btn.textContent = '‚úÖ ƒê√£ l∆∞u!';
  } catch(e) {
    btn.textContent = '‚ùå L·ªói l∆∞u!';
  }
  updateSoCount();
  setTimeout(() => { btn.innerHTML = 'üíæ L∆∞u S·ªï'; }, 1500);
}

async function clearSo() {
  if (!confirm('Xo√° to√†n b·ªô danh s√°ch?\n‚ö†Ô∏è S·∫Ω xo√° v·ªõi t·∫•t c·∫£ m·ªçi ng∆∞·ªùi!')) return;
  soNames = Array(40).fill('');
  document.querySelectorAll('.so-input').forEach(inp => inp.value = '');
  try { await window.storage.delete(SO_KEY, true); } catch(e) {}
  updateSoCount();
}

function updateSoCount() {
  const count = soNames.filter(n => n.trim() !== '').length;
  const el = document.getElementById('soCount');
  if (el) el.textContent = count + ' / 40 t√™n ƒë√£ nh·∫≠p';
}

function buildSoGrid() {
  const grid = document.getElementById('soGrid');
  if (!grid) return;
  grid.innerHTML = ''; // rebuild m·ªói l·∫ßn m·ªü ƒë·ªÉ sync data m·ªõi nh·∫•t

  // ƒê√°nh s·ªë D·ªåC: c·ªôt 1 = 1-10, c·ªôt 2 = 11-20, c·ªôt 3 = 21-30, c·ªôt 4 = 31-40
  // D√πng grid-column + grid-row ƒë·ªÉ ƒë·∫£m b·∫£o v·ªã tr√≠ ch√≠nh x√°c
  for (let i = 0; i < 40; i++) {
    const col = Math.floor(i / 10) + 1;  // c·ªôt 1-4
    const row = (i % 10) + 1;            // h√†ng 1-10
    const displayNum = (col - 1) * 10 + row; // s·ªë th·ª© t·ª± 1-40 theo c·ªôt d·ªçc
    const item = document.createElement('div');
    item.className = 'so-item';
    item.style.cssText = 'grid-column:' + col + ';grid-row:' + row + ';';
    item.innerHTML = '<span class="so-num">' + displayNum + '.</span><input class="so-input" type="text" placeholder="Nh·∫≠p t√™n..." maxlength="30" data-idx="' + i + '" value="' + (soNames[i] || '') + '">';
    grid.appendChild(item);
  }
  grid.querySelectorAll('.so-input').forEach(inp => {
    inp.addEventListener('input', updateSoCount);
  });
  updateSoCount();
}

async function openSo() {
  await loadSoFromStorage();
  buildSoGrid();
  document.querySelectorAll('.so-input').forEach((inp, i) => {
    inp.value = soNames[i] || '';
  });
  updateSoCount();
  document.getElementById('soThienMenhModal').classList.add('open');
}

async function closeSo() {
  await saveSo();
  document.getElementById('soThienMenhModal').classList.remove('open');
}

// ‚îÄ‚îÄ S·ªî B√ÄI T·∫¨P TH√îNG MINH ‚îÄ‚îÄ
const SBT_KEY = 'khoBaiTap_v1';
let khoBaiTap = [];

async function loadKhoFromStorage() {
  try {
    const result = await window.storage.get(SBT_KEY, true);
    if (result && result.value) {
      const parsed = JSON.parse(result.value);
      if (Array.isArray(parsed)) khoBaiTap = parsed;
    }
  } catch(e) { /* gi·ªØ nguy√™n khoBaiTap hi·ªán t·∫°i n·∫øu l·ªói */ }
}

async function saveKhoToStorage() {
  try {
    await window.storage.set(SBT_KEY, JSON.stringify(khoBaiTap), true);
  } catch(e) { console.error('Save kho error:', e); }
}

function switchSbtTab(idx) {
  [0,1].forEach(i => {
    document.getElementById('sbtTab'+i).classList.toggle('active', i===idx);
    document.getElementById('sbtPanel'+i).classList.toggle('active', i===idx);
  });
  // Ch·ªâ hi·ªán n√∫t Xo√° kho khi ·ªü tab Ng√¢n H√†ng C√¢u H·ªèi
  const clearBtn = document.getElementById('sbtClearBtn');
  if (clearBtn) clearBtn.style.display = idx === 1 ? 'inline-block' : 'none';
  if (idx === 1) renderQList();
}

async function openSbt() {
  await loadKhoFromStorage();
  updateSbtStat();
  document.getElementById('soBaiTapModal').classList.add('open');
}

function closeSbt() {
  document.getElementById('soBaiTapModal').classList.remove('open');
}

async function clearSbt() {
  if (!confirm('Xo√° to√†n b·ªô ng√¢n h√†ng c√¢u h·ªèi?\n‚ö†Ô∏è S·∫Ω xo√° v·ªõi t·∫•t c·∫£ m·ªçi ng∆∞·ªùi!')) return;
  khoBaiTap = [];
  await saveKhoToStorage();
  updateSbtStat();
  renderQList();
}

function updateSbtStat() {
  const el = document.getElementById('sbtStat');
  if (el) el.textContent = khoBaiTap.length + ' c√¢u h·ªèi trong kho';
}

// ‚îÄ‚îÄ SMART PARSER ‚îÄ‚îÄ
async function parseBaiTap() {
  const raw = document.getElementById('sbtRawText').value;
  const resultEl = document.getElementById('sbtParseResult');
  if (!raw.trim()) { resultEl.textContent = '‚ö†Ô∏è Vui l√≤ng d√°n n·ªôi dung tr∆∞·ªõc!'; return; }

  const parsed = [];
  const qStartRe   = /^(?:C√¢u\s*)?(\d+)[.:)]\s*(.+)/i;
  const answerRe   = /(?:ƒê√°p\s*√°n|ƒê√ÅP\s*√ÅN|Answer)[:\s]+([A-D])/i;
  const singleLetterRe = /^([A-D])\s*$/i;
  const lineOptRe  = /^([A-D])[.)\-:]?\s+(.+)|^([A-D])[.)\-:](.+)/i;

  // ‚îÄ‚îÄ B∆Ø·ªöC 1: T√°ch th√†nh c√°c lines ‚îÄ‚îÄ
  const allLines = raw.split(/\r?\n/);

  // ‚îÄ‚îÄ B∆Ø·ªöC 2: Gom th√†nh c√°c BLOCK ‚îÄ‚îÄ
  // M·ªói block b·∫Øt ƒë·∫ßu khi g·∫∑p "C√¢u N." / "N."
  // K·∫øt th√∫c khi: (a) d√≤ng tr·∫Øng r·ªìi g·∫∑p c√¢u m·ªõi, ho·∫∑c
  //               (b) SAU khi ƒë√£ c√≥ ƒë√°p √°n D ho·∫∑c d√≤ng ƒë√°p √°n ƒë√∫ng ‚Üí d√≤ng ti·∫øp theo l√† c√¢u m·ªõi
  const blocks = [];
  let cur = [];
  let hasOptD = false;       // ƒë√£ g·∫∑p ƒë√°p √°n D trong block hi·ªán t·∫°i
  let hasAnswerLine = false;  // ƒë√£ g·∫∑p d√≤ng ƒë√°p √°n ƒë√∫ng trong block hi·ªán t·∫°i

  function flushBlock() {
    if (cur.length) { blocks.push(cur); cur = []; }
    hasOptD = false;
    hasAnswerLine = false;
  }

  for (let i = 0; i < allLines.length; i++) {
    const line = allLines[i];
    const t = line.trim();

    const isNewQ    = !!t.match(qStartRe);
    const isOptD    = !!(t.match(lineOptRe) && (t.match(lineOptRe)[1]||t.match(lineOptRe)[3]||'').toUpperCase() === 'D');
    const isAnsLine = !!t.match(answerRe);
    const isSingle  = !!t.match(singleLetterRe);
    const isBlank   = t === '';

    // N·∫øu ƒë√£ k·∫øt th√∫c block (c√≥ ƒë√°p √°n D ho·∫∑c d√≤ng ƒë√°p √°n ƒë√∫ng ho·∫∑c ch·ªØ ƒë∆°n l·∫ª)
    // v√† d√≤ng ti·∫øp theo l√† c√¢u h·ªèi m·ªõi ‚Üí flush ngay
    if ((hasOptD || hasAnswerLine) && isNewQ) {
      flushBlock();
    }
    // D√≤ng tr·∫Øng + d√≤ng sau l√† c√¢u m·ªõi ‚Üí flush
    else if (isBlank && cur.length > 0) {
      const nextLine = (allLines[i+1] || '').trim();
      if (nextLine.match(qStartRe)) { flushBlock(); continue; }
    }

    if (t) cur.push(t);

    // ƒê√°nh d·∫•u tr·∫°ng th√°i block
    if (isOptD) hasOptD = true;
    if (isAnsLine || (isSingle && hasOptD)) hasAnswerLine = true;
  }
  flushBlock(); // flush block cu·ªëi

  // ‚îÄ‚îÄ B∆Ø·ªöC 3: Parse t·ª´ng block ‚îÄ‚îÄ
  for (const lines of blocks) {
    if (!lines.length) continue;

    let qText = '', qFound = false, bodyStart = 0;
    for (let i = 0; i < lines.length; i++) {
      const m = lines[i].match(qStartRe);
      if (m) { qText = m[2].trim(); qFound = true; bodyStart = i + 1; break; }
    }
    if (!qFound || !qText) continue;

    const bodyLines = lines.slice(bodyStart);
    const opts = [];
    let correct = null;

    // ƒê√°p √°n ƒë√∫ng ki·ªÉu "ƒê√°p √°n: A"
    const joined = bodyLines.join(' ');
    const ansMatch = joined.match(answerRe);
    if (ansMatch) correct = ansMatch[1].toUpperCase();

    // ƒê√°p √°n ƒë√∫ng ki·ªÉu ch·ªØ ƒë∆°n l·∫ª sau ƒë√°p √°n D
    if (!correct) {
      let lastOptLine = -1;
      for (let li = 0; li < bodyLines.length; li++) {
        if (bodyLines[li].match(lineOptRe)) lastOptLine = li;
      }
      for (let li = lastOptLine + 1; li < bodyLines.length; li++) {
        const sm = bodyLines[li].match(singleLetterRe);
        if (sm) { correct = sm[1].toUpperCase(); break; }
      }
    }

    // T√°ch ƒë√°p √°n A/B/C/D theo t·ª´ng d√≤ng
    let lineMatched = 0;
    for (const l of bodyLines) {
      if (!l) continue;
      if (l.match(singleLetterRe)) continue;
      if (l.match(answerRe)) continue;
      const m = l.match(lineOptRe);
      if (m) {
        const letter = (m[1]||m[3]).toUpperCase();
        const text   = (m[2]||m[4]).trim();
        opts.push({ letter, text });
        lineMatched++;
      } else if (lineMatched === 0) {
        qText += ' ' + l;
      }
    }

    // Fallback: ƒë√°p √°n tr√™n 1 d√≤ng inline
    if (opts.length < 2) {
      opts.length = 0;
      const oneLine = bodyLines.join(' ').replace(/\s+/g,' ').replace(answerRe,'').trim();
      // T√°ch t·∫°i v·ªã tr√≠ ngay tr∆∞·ªõc A/B/C/D theo sau l√† d·∫•u ph√¢n c√°ch ho·∫∑c space
      const parts = oneLine.split(/\s*(?=[A-D][.)\-:\s])/);
      for (const part of parts) {
        const t = part.trim();
        if (!t) continue;
        // Nh·∫≠n "A.text", "A. text", "A)text", "A) text", "A-text", "A: text"
        const m = t.match(/^([A-D])[.)\-:\s]\s*(.*)/i);
        if (m) {
          const letter = m[1].toUpperCase();
          const text   = m[2].trim(); // c√≥ th·ªÉ r·ªóng ‚Üí ƒë√°p √°n b·ªè tr·ªëng
          opts.push({ letter, text: text || '‚Äî' });
        }
      }
    }

    if (qText) parsed.push({ q: qText.trim(), opts, correct });
  }

  if (parsed.length === 0) {
    resultEl.textContent = '‚ùå Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o. Ki·ªÉm tra: m·ªói c√¢u ph·∫£i c√°ch nhau b·∫±ng 1 d√≤ng tr·∫Øng!';
    resultEl.style.color = '#aa2200';
    return;
  }

  // Merge v√†o kho (tr√°nh tr√πng)
  let added = 0;
  for (const p of parsed) {
    const dup = khoBaiTap.some(k => k.q.trim().toLowerCase() === p.q.trim().toLowerCase());
    if (!dup) { khoBaiTap.push(p); added++; }
  }
  const btn = document.querySelector('.sbt-parse-btn');
  btn.textContent = '‚è≥ ƒêang l∆∞u...';
  await saveKhoToStorage();
  btn.textContent = '‚ö° Ph√¢n T√≠ch D·ªØ Li·ªáu';
  updateSbtStat();
  renderQList();
  resultEl.style.color = '#005500';
  resultEl.textContent = '‚úÖ Ph√¢n t√≠ch xong! T√¨m th·∫•y ' + parsed.length + ' c√¢u, th√™m m·ªõi ' + added + ' c√¢u v√†o kho.';
  setTimeout(() => { switchSbtTab(1); }, 800);
}

async function deleteQuestion(idx) {
  khoBaiTap.splice(idx, 1);
  await saveKhoToStorage();
  updateSbtStat();
  renderQList();
}

function renderQList() {
  const list = document.getElementById('sbtQList');
  if (!list) return;
  if (khoBaiTap.length === 0) {
    list.innerHTML = '<div style="text-align:center;color:rgba(26,58,106,0.4);font-style:italic;padding:40px 0;">Ch∆∞a c√≥ c√¢u h·ªèi n√†o. H√£y d√°n n·ªôi dung v√† ph√¢n t√≠ch!</div>';
    return;
  }
  list.innerHTML = '';
  khoBaiTap.forEach((q, idx) => {
    const card = document.createElement('div');
    card.className = 'sbt-q-card';

    // N√∫t xo√° ‚Äî d√πng addEventListener ƒë·ªÉ tr√°nh l·ªói scope inline onclick
    const delBtn = document.createElement('div');
    delBtn.className = 'sbt-q-del';
    delBtn.title = 'Xo√° c√¢u n√†y';
    delBtn.textContent = '‚úï';
    delBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      deleteQuestion(idx);
    });

    const optsHtml = q.opts.map(o =>
      '<div class="sbt-q-opt' + (q.correct && o.letter===q.correct ? ' correct' : '') + '">' + o.letter + '. ' + o.text + '</div>'
    ).join('');

    const inner = document.createElement('div');
    inner.innerHTML =
      '<div class="sbt-q-num">C√ÇU ' + (idx+1) + (q.correct ? ' ¬∑ ƒê√°p √°n: '+q.correct : ' ¬∑ (Ch∆∞a c√≥ ƒë√°p √°n)') + '</div>' +
      '<div class="sbt-q-text">' + q.q + '</div>' +
      '<div class="sbt-q-opts">' + (optsHtml || '<span style="font-size:11px;color:#888;font-style:italic;">Kh√¥ng c√≥ ƒë√°p √°n</span>') + '</div>';

    card.appendChild(delBtn);
    card.appendChild(inner);
    list.appendChild(card);
  });
}

// B·ªëc ng·∫´u nhi√™n 3 c√¢u kh√¥ng tr√πng t·ª´ kho
async function pickRandom3Questions() {
  await loadKhoFromStorage();
  if (khoBaiTap.length === 0) return null;
  const pool = [...khoBaiTap];
  // Shuffle Fisher-Yates
  for (let i = pool.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i+1));
    [pool[i], pool[j]] = [pool[j], pool[i]];
  }
  return pool.slice(0, Math.min(3, pool.length));
}

// Init: load shared storage on page load
(async () => {
  try { await loadSoFromStorage(); } catch(e) {}
  try { await loadKhoFromStorage(); } catch(e) {}
})();

// ‚îÄ‚îÄ PICK RANDOM NAME ‚îÄ‚îÄ
// L∆∞u t√™n ƒë√£ xu·∫•t hi·ªán g·∫ßn ƒë√¢y
let recentNames = [];

async function pickRandomName() {
  await loadSoFromStorage();
  const valid = soNames.filter(n => n.trim() !== '');
  const pool = valid.length > 0 ? valid : ['Ph·∫°m Qu·ª≥nh Anh','T·∫° Duy B·∫£o','Ma Tr·∫ßn Linh Chi','Nguy·ªÖn Ph·∫°m Gia H√¢n',
    'V≈© L√™ Nh√£ H√¢n','Nguy·ªÖn V≈© Anh Huy','B√πi V√µ Nguy√™n Khoa','Tr·∫ßn Tu·∫•n Ki·ªát',
    'Nguy·ªÖn Th√πy Linh','Nguy·ªÖn Ho√†ng Ka Ly','L√™ Tr√≠ M·∫°nh','Nguy·ªÖn Ph·∫°m Ly Na',
    'L√™ Thi·ªán Nh√¢n','Nguy·ªÖn L√¢m Nh·∫≠t','Ch√¢u M·∫´n Nhi','Nguy·ªÖn Tr·∫ßn Qu·ª≥nh Nh∆∞',
    'Tr·∫ßn Nguy·ªÖn Thanh Nh∆∞','Ph·∫°m Minh Qu√¢n','L√™ VƒÉn Ho√†ng Qu·ªëc','Ch√¢u Tr·∫ßn Di·ªáp Thanh',
    'B√πi Tr·ªçng Th·∫Øng','L√™ Nguy·ªÖn Minh Thi·ªán','Nguy·ªÖn Ng·ªçc Kim Th∆∞','ƒê·ªó Ng·ªçc H∆∞∆°ng Tr√†',
    'V√µ Ng√¥ Ki·ªÅu Trinh','Nguy·ªÖn V√µ Thanh Tr√∫c','L√™ Thanh T√∫','L√™ Ho√†ng Tu·∫•n',
    'V√µ Nh√£ Uy√™n','Nguy·ªÖn Ph·∫°m Nh∆∞ √ù','Ph·∫°m Ng·ªçc Nh∆∞ √ù'];

  // T·∫°o pool tr·ªçng s·ªë: t√™n ch∆∞a xu·∫•t hi·ªán g·∫ßn ƒë√¢y = weight 3, ƒë√£ xu·∫•t hi·ªán = weight 1
  const weighted = [];
  for (const name of pool) {
    const w = recentNames.includes(name) ? 1 : 3;
    for (let j = 0; j < w; j++) weighted.push(name);
  }

  const chosen = weighted[Math.floor(Math.random() * weighted.length)];

  // C·∫≠p nh·∫≠t l·ªãch s·ª≠, gi·ªØ t·ªëi ƒëa n·ª≠a danh s√°ch
  recentNames = [chosen, ...recentNames.filter(n => n !== chosen)]
    .slice(0, Math.max(1, Math.floor(pool.length / 2)));

  return chosen;
}

// Pick random qu·∫ª
function pickRandomQue() {
  const ques = Object.keys(queData);
  return ques[Math.floor(Math.random() * ques.length)];
}

// Init: load from storage on page load
loadSoFromStorage();

let rolling = false;

// Ambient particles
const particlesEl = document.getElementById('particles');
for(let i = 0; i < 12; i++) {
  const p = document.createElement('div');
  p.className = 'particle';
  p.style.cssText = `left:${10+Math.random()*80}%;bottom:${200+Math.random()*150}px;animation-duration:${4+Math.random()*5}s;animation-delay:${Math.random()*6}s;width:${2+Math.random()*3}px;height:${2+Math.random()*3}px;`;
  particlesEl.appendChild(p);
}

function rollDice() {
  if(rolling) return;
  rolling = true;
  const cup = document.getElementById('cupArea');
  cup.classList.add('shaking');
  setTimeout(() => {
    cup.classList.remove('shaking');
    launchSticks();
  }, 700);
}

async function launchSticks() {
  const scene = document.querySelector('.scene');
  const cup = document.getElementById('cupArea');
  const sceneRect = scene.getBoundingClientRect();
  const cupRect = cup.getBoundingClientRect();
  const originX = cupRect.left - sceneRect.left + cupRect.width / 2;
  const originY = cupRect.top - sceneRect.top + 15;

  for(let i = 0; i < 7; i++) {
    const s = document.createElement('div');
    s.style.cssText = `
      position:absolute;
      width:3px;
      height:${26+Math.random()*16}px;
      border-radius:1px;
      background:linear-gradient(to top,#8B6914,#deba68,#8B6914);
      left:${originX-1.5}px;
      top:${originY}px;
      z-index:20;
      pointer-events:none;
      transform-origin:bottom center;
      transition: transform ${0.55+Math.random()*0.3}s cubic-bezier(0.25,0.46,0.45,0.94), opacity 0.5s ease-out;
      transition-delay:${i*0.04}s;
    `;
    scene.appendChild(s);

    const angle = -110 + i * 30 + (Math.random()-0.5)*20;
    const dist = 55 + Math.random()*75;
    const rad = angle * Math.PI / 180;
    const tx = Math.sin(rad) * dist;
    const ty = -Math.abs(Math.cos(rad)) * dist - 20;

    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        s.style.transform = `translate(${tx}px,${ty}px) rotate(${angle+(Math.random()-0.5)*50}deg)`;
        s.style.opacity = '0';
      });
    });
    setTimeout(() => s.remove(), 1200);
  }

  setTimeout(async () => {
    const chosenName = await pickRandomName();
    const queName = pickRandomQue();
    const que = queData[queName];
    document.getElementById('resultName').textContent = chosenName;
    document.getElementById('resultQueName').textContent = '‚ú¶ Qu·∫ª: ' + queName + ' ‚ú¶';
    document.getElementById('resultQueTitle').textContent = que.title;
    document.getElementById('resultSub').textContent = que.desc;
    showScroll();
  }, 550);
}

function showScroll() {
  document.getElementById('resultScroll').classList.add('visible');
  createSparkles();
}

function closeScroll() {
  document.getElementById('resultScroll').classList.remove('visible');
  document.getElementById('sparkleContainer').innerHTML = '';
  setTimeout(() => { rolling = false; }, 400);
}

function createSparkles() {
  const c = document.getElementById('sparkleContainer');
  c.innerHTML = '';
  ['#FFD700','#FF8C00','#FFFACD','#DAA520','#FFA500'].forEach((col,_) => {
    for(let j=0;j<7;j++){
      const s=document.createElement('div');
      s.className='sparkle';
      const tx=(Math.random()-0.5)*260, ty=(Math.random()-0.5)*220;
      s.style.cssText=`left:calc(50% + ${(Math.random()-0.5)*130}px);top:calc(50% + ${(Math.random()-0.5)*90}px);width:${4+Math.random()*8}px;height:${4+Math.random()*8}px;background:${col};--tx:${tx}px;--ty:${ty}px;animation-delay:${Math.random()*0.4}s;animation-duration:${0.7+Math.random()*0.8}s;`;
      c.appendChild(s);
    }
  });
}

document.addEventListener('keydown', e=>{ 
  if(e.key==='Escape') {
    closeScroll();
    closeSo();
    closeSbt();
  }
});

// Click n·ªÅn modal ƒë·ªÉ ƒë√≥ng
document.getElementById('soThienMenhModal').addEventListener('click', function(e) {
  if (e.target === this) closeSo();
});
document.getElementById('soBaiTapModal').addEventListener('click', function(e) {
  if (e.target === this) closeSbt();
});

// ===================== CAMERA QUIZ =====================
const quizData = [
  {
    q: 'Vi·ªát Nam c√≥ bao nhi√™u t·ªânh v√† th√†nh ph·ªë tr·ª±c thu·ªôc trung ∆∞∆°ng?',
    opts: ['58', '62', '63', '65'],
    correct: 2
  },
  {
    q: 'S√¥ng n√†o d√†i nh·∫•t ch·∫£y qua l√£nh th·ªï Vi·ªát Nam?',
    opts: ['S√¥ng H·ªìng', 'S√¥ng Mekong', 'S√¥ng ƒê√†', 'S√¥ng M√£'],
    correct: 1
  },
  {
    q: 'ƒê·ªânh n√∫i cao nh·∫•t Vi·ªát Nam l√† g√¨?',
    opts: ['Ng·ªçc Linh', 'Pu Si Lung', 'Fansipan', 'B·∫°ch M√£'],
    correct: 2
  }
];

let currentQ = 0, selectedOpt = -1, score = 0;
let activeQuizData = null;
let answers = [];

async function openCameraQuiz() {
  closeScroll();
  document.getElementById('cameraQuiz').classList.add('active');
  currentQ = 0; selectedOpt = -1; score = 0; answers = [];
  const picked = await pickRandom3Questions();
  if (picked && picked.length > 0) {
    activeQuizData = picked.map(q => ({
      q: q.q,
      opts: q.opts.length >= 4
        ? q.opts.slice(0,4).map(o => o.text)
        : [...q.opts.map(o => o.text), ...['‚Äî','‚Äî','‚Äî','‚Äî']].slice(0,4),
      correct: q.correct ? (['A','B','C','D'].indexOf(q.correct.toUpperCase())) : -1
    }));
  } else {
    activeQuizData = quizData;
  }
  loadQuestion(0);
}

function closeCameraQuiz() {
  document.getElementById('cameraQuiz').classList.remove('active');
  // Reset quiz v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
  currentQ = 0; selectedOpt = -1; score = 0; answers = [];
  document.getElementById('quizSummary').classList.remove('active');
  document.getElementById('quizOptions').style.display = '';
  document.querySelector('.confirm-bar').style.display = '';
  document.querySelector('.quiz-progress').style.display = '';
  document.querySelector('.quiz-question-box').style.display = '';
  document.getElementById('confirmBtn').disabled = false;
  document.getElementById('confirmBtn').classList.remove('ready');
  rolling = false;
}

function restartQuiz() {
  currentQ = 0; selectedOpt = -1; score = 0; answers = [];
  document.getElementById('quizSummary').classList.remove('active');
  document.getElementById('quizOptions').style.display = '';
  document.querySelector('.confirm-bar').style.display = '';
  document.querySelector('.quiz-progress').style.display = '';
  document.querySelector('.quiz-question-box').style.display = '';
  loadQuestion(0);
}

function loadQuestion(idx) {
  const q = (activeQuizData || quizData)[idx];
  if (!q) return;
  document.getElementById('qNum').textContent = 'C√ÇU ' + (idx+1) + ' / ' + (activeQuizData||quizData).length;
  document.getElementById('qText').textContent = q.q;
  for(let i=0;i<4;i++){
    document.getElementById('optText'+i).textContent = q.opts[i];
    document.getElementById('opt'+i).className = 'quiz-option';
  }
  for(let i=0;i<3;i++){
    const d = document.getElementById('dot'+i);
    d.className = 'progress-dot';
    if(i < idx) d.classList.add('done');
    else if(i === idx) d.classList.add('active');
  }
  selectedOpt = -1;
  document.getElementById('confirmBtn').disabled = false;
  document.getElementById('confirmBtn').classList.remove('ready');
}

function selectOption(idx) {
  // N·∫øu ƒë√£ x√°c nh·∫≠n r·ªìi th√¨ kh√¥ng cho ƒë·ªïi
  if(document.getElementById('confirmBtn').disabled) return;
  // Cho ph√©p ƒë·ªïi l·ª±a ch·ªçn t·ª± do tr∆∞·ªõc khi x√°c nh·∫≠n
  for(let i=0;i<4;i++) document.getElementById('opt'+i).className = 'quiz-option';
  document.getElementById('opt'+idx).classList.add('hovered');
  selectedOpt = idx;
  document.getElementById('confirmBtn').classList.add('ready');
}

function confirmAnswer() {
  if(selectedOpt === -1) return;
  // V√¥ hi·ªáu ho√° c√°c ƒë√°p √°n v√† n√∫t sau khi x√°c nh·∫≠n
  document.getElementById('confirmBtn').disabled = true;
  document.getElementById('confirmBtn').classList.remove('ready');
  const q = (activeQuizData || quizData)[currentQ];
  const correct = q.correct;
  const hasAnswer = correct !== -1 && correct !== null;
  answers.push({q: q.q, opts: q.opts, chosen: selectedOpt, correct});
  if(hasAnswer && selectedOpt === correct) score++;
  for(let i=0;i<4;i++){
    const opt = document.getElementById('opt'+i);
    opt.className = 'quiz-option';
    if(hasAnswer && i === correct) opt.classList.add('reveal-correct');
    if(hasAnswer && i === selectedOpt && selectedOpt !== correct) opt.classList.add('selected-wrong');
  }
  document.getElementById('confirmBtn').classList.remove('ready');
  setTimeout(() => {
    currentQ++;
    const total = (activeQuizData || quizData).length;
    if(currentQ >= total) showSummary();
    else { selectedOpt = -1; loadQuestion(currentQ); }
  }, 1500);
}

function showSummary() {
  document.getElementById('quizOptions').style.display = 'none';
  document.querySelector('.confirm-bar').style.display = 'none';
  document.querySelector('.quiz-progress').style.display = 'none';
  document.querySelector('.quiz-question-box').style.display = 'none';
  document.getElementById('quizSummary').classList.add('active');
  const totalQ = (activeQuizData || quizData).length;
  document.getElementById('quizSummary').querySelector('.summary-score').innerHTML = 'ƒê√∫ng <span>' + score + '</span>/' + totalQ;
  const items = document.getElementById('summaryItems');
  items.innerHTML = '';
  answers.forEach((a,i)=>{
    const right = a.chosen === a.correct;
    const div = document.createElement('div');
    div.className = 'summary-item ' + (right?'s-correct':'s-wrong');
    div.innerHTML = '<span class="s-icon">'+(right?'‚úÖ':'‚ùå')+'</span>'
      +'<span class="s-text">C√¢u '+(i+1)+': '+a.q.substring(0,45)+'...</span>'
      +'<span class="s-ans">'+['A','B','C','D'][a.chosen]+'</span>';
    items.appendChild(div);
  });
  const msgs = ['üìö C·∫ßn √¥n t·∫≠p th√™m nh√©!','üëè Kh√¥ng t·ªá! Ti·∫øp t·ª•c c·ªë g·∫Øng!','üåü Xu·∫•t s·∫Øc! B·∫°n th·∫≠t th√¥ng minh!','üèÜ Ho√†n h·∫£o!'];
  document.getElementById('summaryMsg').textContent = msgs[Math.min(score, msgs.length-1)];
}
</script>
</body>
</html>